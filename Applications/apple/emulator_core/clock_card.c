#include "clock_card.h"
#include "board.h"
#include "io_addr.h"
#include "cpu.h"
#include "ram_ctrl.h"
#include "tima_libc.h"

#ifdef ENABLE_EMBEDDED_ASM
#include "embedded.h"
#endif

//////////////////////////////////////////////////////////////////////////////////////

#define CLOCK_USE_FILE
#define CLOCK_FW_BINARY		"rom/clock_fw.bin"
#define CLOCK_FW_SOURCE		"fw/clock_driver/clock_src.asm"

//////////////////////////////////////////////////////////////////////////////////////

#ifdef CLOCK_USE_FILE

static uint8_t clock_drive_fw[4096];
static const char * clock_source_list[2] =
{
	CLOCK_FW_SOURCE,
	NULL
};

#else
const static uint8_t clock_drive_fw[4096] =
{
	0x08, 0xA2, 0x28, 0xA2, 0x58, 0xA2, 0x70, 0x28, 0x18, 0x90, 0x03, 0x18, 0x90, 0x3A, 0x48, 0x20, 
	0x58, 0xFF, 0xBA, 0xBD, 0x00, 0x01, 0x0A, 0x0A, 0x0A, 0x0A, 0x85, 0x2B, 0xAA, 0x68, 0x9D, 0x81, 
	0xC0, 0xA5, 0x40, 0x48, 0xA5, 0x41, 0x48, 0xA9, 0x00, 0x85, 0x40, 0xA9, 0x02, 0x85, 0x41, 0xA0, 
	0x00, 0xBD, 0x83, 0xC0, 0xC9, 0x00, 0xF0, 0x05, 0x91, 0x40, 0xC8, 0xD0, 0xF4, 0xA9, 0x00, 0x91, 
	0x40, 0x68, 0x85, 0x41, 0x68, 0x85, 0x40, 0x60, 0x48, 0x20, 0x58, 0xFF, 0xBA, 0xBD, 0x00, 0x01, 
	0x0A, 0x0A, 0x0A, 0x0A, 0x85, 0x2B, 0xAA, 0x68, 0x9D, 0x80, 0xC0, 0x60, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
};
#endif

/////////////////////////////////////////////////////////////////////////////////////

static board_data_t * board;
static char rtc_buffer[80];
static uint8_t byte_cnt;
static uint8_t clock_mode;

/////////////////////////////////////////////////////////////////////////////////////

static uint8_t clock_card_io_controller( uint8_t address, uint8_t data )
{
    struct tm * time_tm;
    time_t time_now;
	uint8_t ret = 0xA0;

	switch( address & 0x0F )
	{
		case 0x00:
			clock_mode = data;
			break;

		case 0x01:
            time( &time_now );
            time_tm = localtime( &time_now );

			if( clock_mode == 0xA3 )
			{
				sprintf( rtc_buffer, "%02d,%02d,%02d,%02d,%02d,%02d", time_tm->tm_mon+1,
																	  time_tm->tm_wday,
																	  time_tm->tm_mday,
																	  time_tm->tm_hour,
																	  time_tm->tm_min,
																	  time_tm->tm_sec );
			}
			else
			{
			    rtc_buffer[0] = 0;
			}

			byte_cnt = 0;
			break;

		case 0x02:
			break;

		case 0x03:
			ret = rtc_buffer[byte_cnt];

			if( ret == 0 )
			{
			    byte_cnt = 0;
			}
			else
			{
				ret |= 0x80;
				byte_cnt++;
			}
			break;
	}

	return ret;
}

#ifdef CLOCK_USE_FILE
void clock_fw_rebuild( bool_t force_build )
{
	if( ( board_disc_image_access( CLOCK_FW_BINARY, Disc_Mode_Size, 0, ( uint8_t * )&clock_drive_fw[0], 256 ) == 0 ) ||
		( force_build == TRUE ) )
	{
		#ifdef ENABLE_EMBEDDED_ASM
		assembler( clock_source_list, 1, CLOCK_FW_BINARY, board );
		#endif
	}
}
#endif

void clock_card_insert( uint8_t slot )
{
	int counter;
	uint8_t page = ( 0x08 + slot ) << 4;

	#ifdef CLOCK_USE_FILE
	clock_fw_rebuild( FALSE );
    board_disc_image_access( CLOCK_FW_BINARY, Disc_Mode_Read, 0, ( uint8_t * )&clock_drive_fw[0], 256 );
	#endif

	ram_ctrl_insert_slot( slot, ( uint8_t * )clock_drive_fw );

	for( counter = 0; counter < 16; counter++ )
	{
		memory_io_set_handler( page + counter, clock_card_io_controller, clock_card_io_controller );
	}
}

void clock_card_init( void * p_board )
{
	board = ( board_data_t * )p_board;
	//tima_rtc_init();
}
